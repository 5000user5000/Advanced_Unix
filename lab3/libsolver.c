#include <stdio.h>
#include <stdlib.h>
#include <dlfcn.h>
#include <string.h>
#include <unistd.h>
#include "libgotoku.h"
#include <sys/mman.h>


#define OPS_MAX (1200)


// 在共享庫載入時印出挑戰字串
__attribute__((constructor))
static void init_solver() {
    fprintf(stderr, "UP113_GOT_PUZZLE_CHALLENGE\n");
}

static void *main_ptr = NULL;

// 重載 game_init：呼叫原始 game_init 後，取得 main 函數地址並印出
int game_init() {
    int (*orig_game_init)() = dlsym(RTLD_NEXT, "game_init");
    int ret = orig_game_init();
    main_ptr = game_get_ptr();
    fprintf(stderr, "SOLVER: _main = %p\n", main_ptr);
    return ret;
}

// 判斷在 (row, col) 放入 num 是否合法
int is_valid(int board[9][9], int row, int col, int num) {
    for (int c = 0; c < 9; c++) {
        if (board[row][c] == num) return 0;
    }
    for (int r = 0; r < 9; r++) {
        if (board[r][col] == num) return 0;
    }
    int sr = (row / 3) * 3;
    int sc = (col / 3) * 3;
    for (int r = 0; r < 3; r++) {
        for (int c = 0; c < 3; c++) {
            if (board[sr + r][sc + c] == num) return 0;
        }
    }
    return 1;
}

// 標準回溯法求解 sudoku，成功回傳 1 並填滿 board，否則回傳 0
int sudoku_solve(int board[9][9]) {
    for (int row = 0; row < 9; row++) {
        for (int col = 0; col < 9; col++) {
            if (board[row][col] == 0) {
                for (int num = 1; num <= 9; num++) {
                    if (is_valid(board, row, col, num)) {
                        board[row][col] = num;
                        if (sudoku_solve(board))
                            return 1;
                        board[row][col] = 0;
                    }
                }
                return 0;
            }
        }
    }
    return 1;
}

// 模擬從目前光標移動到目標位置並填入數字
// 這裡採用最簡單的方法：以 gop_down 及 gop_right 進行正向移動（利用 mod 9 會剛好回到對應位置）
void move_to_and_fill(gotoku_t *gt, int target_row, int target_col, int num,int ops[],int *ops_len) {
    int cur_row = gt->y;
    int cur_col = gt->x;
    // printf("cur row = %d , cur col = %d \n",cur_row,cur_col);
    // 計算正向移動步數（注意：由於 board 為環狀，(current + diff) % 9 == target）
    int dr = (target_row - cur_row + 9) % 9;
    int dc = (target_col - cur_col + 9) % 9;
    // 依序移動
    for (int i = 0; i < dr; i++) {
        // void (*gop_down_func)() = dlsym(RTLD_NEXT, "gop_down");
        // gop_down_func();
        ops[*ops_len] = 1;
        (*ops_len)++;
        gt->y = (gt->y + 1) % 9;  // 更新光標
    }
    for (int i = 0; i < dc; i++) {
        // void (*gop_right_func)() = dlsym(RTLD_NEXT, "gop_right");
        // gop_right_func();
        ops[*ops_len] = 3;
        (*ops_len)++;
        gt->x = (gt->x + 1) % 9;  // 更新光標
    }
    // fprintf(stderr, "Filling cell (%d,%d) with %d; cursor now at (%d,%d)\n",target_row, target_col, num, gt->y, gt->x);
    // 根據數字呼叫對應的填數函數
    // char func_name[20];
    // sprintf(func_name, "gop_fill_%d", num);
    // void (*fill_func)() = dlsym(RTLD_NEXT, func_name);
    // fill_func();
    ops[*ops_len] = num+3;
    (*ops_len)++;
    gt->x = target_col;
    gt->y = target_row;
}

// 模擬解題流程：對原本為空的格子依序移動並填入 sudoku 求解後的數字
void simulate_solution(gotoku_t *gt, int original[9][9], int solved[9][9],int ops[],int *ops_len) {

    // gt->x = 7; gt->y = 8; //local，因為 local 的光標是 (7,8) 開始，而 global 則是 (0,0)，這個是預設值
    fprintf(stderr, "Solved board:\n");
    for (int i = 0; i < 9; i++) {
        for (int j = 0; j < 9; j++) {
            fprintf(stderr, "%d ", solved[i][j]);
        }
        fprintf(stderr, "\n");
    }
    // 依序掃描棋盤，對原始為 0 的格子執行移動與填數
    for (int row = 0; row < 9; row++) {
        for (int col = 0; col < 9; col++) {
            if (original[row][col] == 0) {
                move_to_and_fill(gt, row, col, solved[row][col],ops,ops_len);
            }
        }
    }
}

// 新增：將操作碼轉換成函數指標後 patch 到 GOT 表
void patch_got(int ops[], int ops_len) {
    // gop__target[] 為 GOT entry 相對於 main_ptr 的 offset（必須與 gops.c 呼叫順序一致）

    // server
    int gop__target[] = { 0x589f, 0x5407, 0x6197, 0x5d0f, 0x6be7, 0x66e7, 0x4faf, 0x6f27, 0x5767, 0x547f, 0x4fdf, 0x70c7, 0x6bff, 0x670f, 0x631f, 0x5e4f, 0x59ef, 0x555f, 0x50c7, 0x6ab7, 0x65c7, 0x6137, 0x5c8f, 0x5807, 0x5387, 0x4f47, 0x7027, 0x6b87, 0x66a7, 0x6007, 0x5b67, 0x56cf, 0x5257, 0x7337, 0x6e7f, 0x69a7, 0x6547, 0x60af, 0x5c37, 0x50ff, 0x71df, 0x6d17, 0x681f, 0x637f, 0x5ef7, 0x5a3f, 0x55af, 0x51af, 0x7297, 0x639f, 0x5f1f, 0x5a7f, 0x55f7, 0x5127, 0x721f, 0x6d6f, 0x685f, 0x63af, 0x5f2f, 0x7107, 0x6c4f, 0x676f, 0x626f, 0x5dcf, 0x5937, 0x54af, 0x502f, 0x7117, 0x6c37, 0x5cbf, 0x583f, 0x53a7, 0x4ebf, 0x6fb7, 0x6adf, 0x65f7, 0x616f, 0x5ca7, 0x5827, 0x69f7, 0x64c7, 0x6047, 0x5ba7, 0x570f, 0x528f, 0x4dbf, 0x6eaf, 0x69e7, 0x6487, 0x7217, 0x6d67, 0x6857, 0x63a7, 0x5f27, 0x5a6f, 0x55e7, 0x50f7, 0x71e7, 0x6d87, 0x6987, 0x5207, 0x72ff, 0x5bd7, 0x573f, 0x64d7, 0x605f, 0x6ed7, 0x6a0f, 0x5297, 0x4e9f, 0x5c3f, 0x57ef, 0x65a7, 0x60ff, 0x6fdf, 0x6b07, 0x53cf, 0x4ee7, 0x5ce7, 0x66ef, 0x624f, 0x7097, 0x6bf7, 0x5477, 0x4f8f, 0x5df7, 0x595f, 0x675f, 0x629f, 0x6817, 0x510f, 0x71f7, 0x59ff, 0x5597, 0x6357, 0x5ebf, 0x6d97, 0x6887, 0x513f, 0x5bbf, 0x56c7, 0x649f, 0x602f, 0x6e37, 0x697f, 0x51ff, 0x72f7, 0x5bcf, 0x5737, 0x6e1f, 0x6997, 0x525f, 0x7347, 0x5b6f, 0x56df, 0x6497, 0x6027, 0x6ea7, 0x69df, 0x57ff, 0x65d7, 0x613f, 0x6f87, 0x6abf, 0x536f, 0x4e97, 0x5c9f, 0x581f, 0x65bf, 0x4ff7, 0x70cf, 0x58ff, 0x548f, 0x623f, 0x5da7, 0x6c2f, 0x6757, 0x4fa7, 0x70ff, 0x5eff, 0x6d27, 0x682f, 0x5107, 0x71ff, 0x5a67, 0x55ef, 0x6367, 0x5f17, 0x6d8f, 0x56d7, 0x648f, 0x601f, 0x6e9f, 0x69d7, 0x521f, 0x4da7, 0x5bb7, 0x572f, 0x64ef, 0x68f7, 0x6e07, 0x72a7, 0x518f, 0x5707, 0x5b7f, 0x6017, 0x64a7, 0x69af, 0x6e97, 0x59df, 0x5e5f, 0x62ef, 0x6847, 0x6d37, 0x71ef, 0x5117, 0x55bf, 0x5a47, 0x5f07, 0x666f, 0x6b57, 0x705f, 0x4f67, 0x542f, 0x5917, 0x5daf, 0x6247, 0x66f7, 0x6c07, 0x4e37, 0x52ff, 0x577f, 0x5c17, 0x60c7, 0x6537, 0x6ad7, 0x6f8f, 0x4e8f, 0x5377, 0x5b0f, 0x5fb7, 0x6427, 0x68ef, 0x6dff, 0x729f, 0x5187, 0x56ff, 0x5b77, 0x600f, 0x6837, 0x6cdf, 0x719f, 0x5097, 0x552f, 0x59d7, 0x5e57, 0x62e7, 0x683f, 0x6d2f, 0x575f, 0x5c2f, 0x60df, 0x6557, 0x6a67, 0x6f47, 0x4e3f, 0x52f7, 0x57e7, 0x5c87, 0x6e17, 0x72d7, 0x51bf, 0x565f, 0x5b27, 0x5faf, 0x641f, 0x6977, 0x6e77, 0x72b7, 0x5eaf, 0x632f, 0x67df, 0x6cef, 0x7197, 0x509f, 0x558f, 0x5a37, 0x5e67, 0x635f, 0x4f77, 0x543f, 0x58c7, 0x5d67, 0x61e7, 0x66df, 0x6bdf, 0x702f, 0x4f9f, 0x5497, 0x68a7, 0x6467, 0x5fc7, 0x5b1f, 0x566f, 0x51df, 0x72ef, 0x6e27, 0x692f, 0x63b7, 0x650f, 0x607f, 0x5bef, 0x5757, 0x5337, 0x4e4f, 0x6f3f, 0x6a77, 0x6567, 0x60f7, 0x4f1f, 0x6ff7, 0x6b27, 0x669f, 0x61f7, 0x5d6f, 0x58cf, 0x544f, 0x4f87, 0x7077, 0x67af, 0x62b7, 0x5e1f, 0x5977, 0x54ef, 0x50b7, 0x71a7, 0x6ce7, 0x67e7, 0x633f, 0x5acf, 0x563f, 0x514f, 0x724f, 0x6daf, 0x689f, 0x645f, 0x5fbf, 0x5b17, 0x5667, 0x4dd7, 0x6ef7, 0x6a2f, 0x6507, 0x6077, 0x5be7, 0x574f, 0x532f, 0x4e47, 0x6f37, 0x667f, 0x619f, 0x5d17, 0x588f, 0x53ff, 0x4f17, 0x6fef, 0x6b1f, 0x6697, 0x61ef, 0x4eef, 0x7007, 0x6b3f, 0x6627, 0x61a7, 0x5d1f, 0x5877, 0x540f, 0x4f6f, 0x703f, 0x5e27, 0x59a7, 0x550f, 0x504f, 0x7147, 0x6c9f, 0x67b7, 0x6327, 0x5e7f, 0x597f, 0x6ddf, 0x68d7, 0x63e7, 0x5f57, 0x5ac7, 0x5637, 0x51b7, 0x72bf, 0x6db7, 0x68ff, 0x686f, 0x6d5f, 0x5f7f, 0x63f7, 0x562f, 0x5adf, 0x7267, 0x517f, 0x68e7, 0x6dd7, 0x592f, 0x7167, 0x505f, 0x67a7, 0x6caf, 0x5e3f, 0x62d7, 0x5527, 0x599f, 0x70d7, 0x4ecf, 0x53df, 0x6af7, 0x6faf, 0x61b7, 0x6637, 0x5887, 0x5d2f, 0x4f27, 0x541f, 0x64e7, 0x5727, 0x5b9f, 0x4dff, 0x52c7, 0x6a1f, 0x6f17, 0x608f, 0x651f, 0x5777, 0x5a77, 0x7227, 0x5147, 0x6867, 0x6d57, 0x5f77, 0x63ef, 0x5627, 0x5ad7, 0x725f, 0x6767, 0x6c3f, 0x5dd7, 0x628f, 0x54b7, 0x5927, 0x715f, 0x5057, 0x679f, 0x6ca7, 0x65ef, 0x582f, 0x5caf, 0x4ec7, 0x53d7, 0x6aef, 0x6fa7, 0x61af, 0x662f, 0x587f, 0x4ddf, 0x5277, 0x69ef, 0x6eb7, 0x604f, 0x64df, 0x571f, 0x5b97, 0x4df7, 0x52bf, 0x5dc7, 0x6297, 0x54d7, 0x5957, 0x710f, 0x5027, 0x674f, 0x6c47, 0x5e17, 0x62cf, 0x4edf, 0x65ff, 0x6aff, 0x5cb7, 0x6167, 0x53c7, 0x5837, 0x6fff, 0x4f0f, 0x65e7, 0x50e7, 0x71d7, 0x5a2f, 0x5587, 0x6377, 0x5ee7, 0x6eef, 0x6a07, 0x52af, 0x4dcf, 0x5fff, 0x6e6f, 0x695f, 0x5247, 0x731f, 0x5d07, 0x5867, 0x6617, 0x618f, 0x6fd7, 0x6c67, 0x6587, 0x4e77, 0x6f7f, 0x57df, 0x5367, 0x612f, 0x5c7f, 0x6c97, 0x6787, 0x5467, 0x6237, 0x5d9f, 0x6bd7, 0x66c7, 0x4fd7, 0x70b7, 0x5abf, 0x560f, 0x63d7, 0x5edf, 0x6ee7, 0x69ff, 0x52a7, 0x4dc7, 0x5bc7, 0x5747, 0x64f7, 0x6067, 0x6eff, 0x523f, 0x7317, 0x5cff, 0x585f, 0x660f, 0x6187, 0x6fcf, 0x6b17, 0x53ef, 0x4ef7, 0x535f, 0x6127, 0x5c77, 0x6c8f, 0x677f, 0x503f, 0x713f, 0x596f, 0x54e7, 0x62af, 0x6bcf, 0x66bf, 0x4fcf, 0x70af, 0x5ab7, 0x5607, 0x63cf, 0x5f4f, 0x6da7, 0x6897, 0x5b47, 0x568f, 0x6447, 0x5f97, 0x6ecf, 0x680f, 0x50df, 0x71cf, 0x5a27, 0x557f, 0x6a97, 0x530f, 0x4e1f, 0x5cd7, 0x56bf, 0x647f, 0x5ff7, 0x6e67, 0x6957, 0x5237, 0x508f, 0x5547, 0x59bf, 0x5e97, 0x6317, 0x69c7, 0x6e8f, 0x4db7, 0x526f, 0x56f7, 0x55a7, 0x58b7, 0x5d47, 0x61df, 0x6667, 0x6b6f, 0x7057, 0x4f5f, 0x55d7, 0x5a57, 0x6a57, 0x6f2f, 0x4e17, 0x52ef, 0x578f, 0x5c0f, 0x60bf, 0x673f, 0x6c17, 0x70f7, 0x51a7, 0x5817, 0x5c97, 0x615f, 0x65df, 0x6acf, 0x6f9f, 0x4eb7, 0x539f, 0x5847, 0x5e8f, 0x630f, 0x69bf, 0x6e87, 0x4daf, 0x5267, 0x56ef, 0x5b8f, 0x603f, 0x64bf, 0x6b67, 0x704f, 0x4f57, 0x55cf, 0x5a4f, 0x5f0f, 0x6397, 0x684f, 0x6d47, 0x720f, 0x52e7, 0x5787, 0x5c07, 0x60b7, 0x6737, 0x6c0f, 0x70ef, 0x501f, 0x549f, 0x591f, 0x6a47, 0x6f1f, 0x4de7, 0x52b7, 0x57f7, 0x5af7, 0x5f8f, 0x6417, 0x691f, 0x6def, 0x5aef, 0x5f5f, 0x63df, 0x698f, 0x6ccf, 0x7177, 0x5087, 0x553f, 0x59b7, 0x5e87, 0x7157, 0x5047, 0x559f, 0x58af, 0x5d3f, 0x61d7, 0x665f, 0x6b5f, 0x7047, 0x4f4f, 0x51c7, 0x712f, 0x6c7f, 0x6797, 0x62c7, 0x5e0f, 0x5997, 0x5507, 0x51f7, 0x72e7, 0x5f3f, 0x5a9f, 0x561f, 0x5167, 0x7247, 0x6dc7, 0x68bf, 0x659f, 0x60ef, 0x5c5f, 0x529f, 0x4f97, 0x706f, 0x6ba7, 0x66af, 0x621f, 0x5d77, 0x58ef, 0x5457, 0x4fe7, 0x6b37, 0x661f, 0x634f, 0x5eb7, 0x5a0f, 0x5567, 0x50bf, 0x71af, 0x6d0f, 0x67ef, 0x5e07, 0x598f, 0x54ff, 0x51ef, 0x72df, 0x6e4f, 0x6947, 0x6457, 0x5fd7, 0x5b57, 0x515f, 0x723f, 0x6dbf, 0x68b7, 0x6597, 0x60e7, 0x5c57, 0x57af, 0x5327, 0x4e5f, 0x6177, 0x5cdf, 0x584f, 0x53bf, 0x4f7f, 0x6edf, 0x6a17, 0x64ff, 0x606f, 0x5bdf, 0x711f, 0x6c6f, 0x6747, 0x6337, 0x5cef, 0x586f, 0x53f7, 0x4f07, 0x6fe7, 0x6b2f, 0x5a8f, 0x55df, 0x51cf, 0x7127, 0x6c77, 0x678f, 0x62bf, 0x5dff, 0x5987, 0x54f7, 0x69cf, 0x655f, 0x5f37, 0x5a97, 0x5617, 0x5157, 0x7237, 0x6dcf, 0x68af, 0x658f, 0x5017, 0x672f, 0x6c27, 0x5def, 0x6287, 0x54cf, 0x594f, 0x7287, 0x5177, 0x690f, 0x6ae7, 0x5e47, 0x62df, 0x5537, 0x59af, 0x716f, 0x5067, 0x67bf, 0x6cbf, 0x5e9f, 0x5287, 0x5717, 0x701f, 0x4f2f, 0x6657, 0x6b4f, 0x5d37, 0x61bf, 0x5417, 0x58a7, 0x5137, 0x687f, 0x6d7f, 0x609f, 0x6517, 0x5797, 0x5bff, 0x4def, 0x52df, 0x6a4f, 0x5de7, 0x627f, 0x54c7, 0x5947, 0x727f, 0x516f, 0x6907, 0x6de7, 0x5f6f, 0x63ff, 0x70e7, 0x5007, 0x6707, 0x6bb7, 0x5e37, 0x6157, 0x53b7, 0x580f, 0x6fbf, 0x4ed7, 0x6147, 0x537f, 0x57c7, 0x700f, 0x4d9f, 0x64cf, 0x69b7, 0x5baf, 0x6057, 0x527f, 0x699f, 0x6e57, 0x6087, 0x638f, 0x55c7, 0x5a5f, 0x722f, 0x512f, 0x6877, 0x6d77, 0x5a17, 0x7257, 0x500f, 0x6727, 0x6c1f, 0x5ddf, 0x6277, 0x54bf, 0x593f, 0x7277, 0x6257, 0x54a7, 0x5907, 0x70df, 0x4fff, 0x66ff, 0x6baf, 0x5e2f, 0x614f, 0x53af, 0x522f, 0x730f, 0x5cf7, 0x5857, 0x6607, 0x617f, 0x6fc7, 0x6b0f, 0x53e7, 0x4eff, 0x5357, 0x611f, 0x5c6f, 0x6c87, 0x6777, 0x5037, 0x7137, 0x5967, 0x54df, 0x62a7, 0x6bc7, 0x66d7, 0x4fc7, 0x70a7, 0x5aaf, 0x55ff, 0x63c7, 0x5f47, 0x6d9f, 0x688f, 0x5b3f, 0x5687, 0x643f, 0x5fa7, 0x6ec7, 0x6807, 0x50d7, 0x71c7, 0x5a1f, 0x5577, 0x6a8f, 0x531f, 0x4e2f, 0x5ccf, 0x56b7, 0x6477, 0x5fef, 0x6e5f, 0x694f, 0x5227, 0x6217, 0x5d5f, 0x6c5f, 0x657f, 0x4e6f, 0x6f77, 0x57d7, 0x534f, 0x6117, 0x5c67, 0x718f, 0x5a87, 0x545f, 0x622f, 0x5d97, 0x6bbf, 0x66cf, 0x4fbf, 0x709f, 0x5aa7, 0x6937, 0x51d7, 0x72cf, 0x5b37, 0x567f, 0x6437, 0x5f9f, 0x6ebf, 0x67ff, 0x50cf, 0x5c1f, 0x57a7, 0x656f, 0x60d7, 0x6f57, 0x6a87, 0x5317, 0x4e27, 0x5cc7, 0x56af, 0x7067, 0x58e7, 0x5447, 0x620f, 0x5d57, 0x6c57, 0x6577, 0x4e67, 0x6f6f, 0x57cf, 0x6aaf, 0x6f67, 0x4e87, 0x5347, 0x58df, 0x5d87, 0x6207, 0x668f, 0x6b8f, 0x707f, 0x66b7, 0x6d07, 0x71bf, 0x50af, 0x5557, 0x59f7, 0x5ec7, 0x6347, 0x67f7, 0x6d1f, 0x50ef, 0x556f, 0x5b4f, 0x5fdf, 0x644f, 0x693f, 0x6e2f, 0x7307, 0x51e7, 0x56a7, 0x733f, 0x524f, 0x56e7, 0x5b87, 0x6037, 0x64b7, 0x696f, 0x6e47, 0x732f, 0x5217, 0x65cf, 0x6ac7, 0x6f97, 0x4eaf, 0x5397, 0x57bf, 0x5c4f, 0x610f, 0x65b7, 0x6aa7, 0x6bef, 0x70bf, 0x4fef, 0x5487, 0x590f, 0x5dbf, 0x6267, 0x671f, 0x6b9f, 0x708f, 0x5eef, 0x6387, 0x6827, 0x6d3f, 0x7207, 0x511f, 0x55b7, 0x5a07, 0x5ecf, 0x636f, 0x64af, 0x6967, 0x6e3f, 0x7327, 0x520f, 0x5697, 0x5b5f, 0x5fe7, 0x646f, 0x6a6f, 0x4ea7, 0x538f, 0x57b7, 0x5c47, 0x6107, 0x65af, 0x6a9f, 0x6f5f, 0x4e7f, 0x533f, 0x5db7, 0x625f, 0x6717, 0x6b97, 0x7087, 0x4fb7, 0x546f, 0x58f7, 0x5d8f, 0x6227, 0x6917, 0x640f, 0x5f87, 0x5b07, 0x5657, 0x52d7, 0x4e0f, 0x6f0f, 0x6a3f, 0x652f, 0x507f, 0x7187, 0x6cd7, 0x68df, 0x6407, 0x5f67, 0x5ae7, 0x5647, 0x5197, 0x726f, 0x664f, 0x61cf, 0x5d4f, 0x58bf, 0x5517, 0x506f, 0x714f, 0x6cb7, 0x67c7, 0x62f7, 0x6a5f, 0x663f, 0x61c7, 0x5d27, 0x5897, 0x5427, 0x4f37, 0x7017, 0x6b47, 0x6677, 0x5aff, 0x564f, 0x52cf, 0x4e07, 0x6f07, 0x6a37, 0x6527, 0x6097, 0x5bf7, 0x576f, 0x5ea7, 0x59e7, 0x554f, 0x50a7, 0x71b7, 0x6cff, 0x67d7, 0x6307, 0x5e77, 0x59cf, 0x6b7f, 0x6687, 0x61ff, 0x5d7f, 0x58d7, 0x5437, 0x4f3f, 0x7037, 0x6b77, 0x6647, 0x654f, 0x60cf, 0x5c27, 0x579f, 0x5307, 0x4e57, 0x6f4f, 0x6a7f, 0x653f, 0x60a7, 0x72c7, 0x6e0f, 0x6927, 0x642f, 0x5fcf, 0x5b2f, 0x5677, 0x519f, 0x728f, 0x6df7, 0x6cf7, 0x67cf, 0x62ff, 0x5e6f, 0x59c7, 0x551f, 0x5077, 0x717f, 0x6cc7, 0x68cf, 0x68c7};

    // local
    // int gop__target[] = { 0x54ef, 0x674f, 0x547f, 0x6777, 0x5647, 0x68ef, 0x5617, 0x63df, 0x76ff, 0x6a37, 0x5767, 0x6a6f, 0x579f, 0x6aa7, 0x5a57, 0x6d17, 0x5ad7, 0x6daf, 0x5ac7, 0x5287, 0x6587, 0x52b7, 0x65b7, 0x52e7, 0x65d7, 0x5557, 0x684f, 0x55cf, 0x68d7, 0x73cf, 0x6117, 0x7427, 0x6127, 0x744f, 0x617f, 0x748f, 0x6387, 0x7677, 0x6427, 0x5bef, 0x6eb7, 0x5bff, 0x6f17, 0x5c1f, 0x6f2f, 0x5c4f, 0x6f5f, 0x5ef7, 0x71ff, 0x5bf7, 0x6ef7, 0x5c3f, 0x6f3f, 0x5bb7, 0x6e97, 0x5bc7, 0x6eaf, 0x5c67, 0x6f87, 0x6a0f, 0x576f, 0x6a77, 0x56ff, 0x69a7, 0x571f, 0x69bf, 0x57a7, 0x6aaf, 0x5737, 0x65bf, 0x528f, 0x6517, 0x5247, 0x653f, 0x5257, 0x65df, 0x531f, 0x658f, 0x527f, 0x7457, 0x60e7, 0x7397, 0x60ff, 0x73b7, 0x618f, 0x749f, 0x611f, 0x741f, 0x5fef, 0x6e8f, 0x5bbf, 0x6ea7, 0x5c5f, 0x6f7f, 0x5c07, 0x6ed7, 0x5b1f, 0x6ddf, 0x5c57, 0x7277, 0x5f17, 0x71f7, 0x60af, 0x7347, 0x601f, 0x737f, 0x60ef, 0x738f, 0x60f7, 0x76b7, 0x637f, 0x76bf, 0x6397, 0x766f, 0x64ef, 0x77a7, 0x6487, 0x77cf, 0x650f, 0x689f, 0x557f, 0x685f, 0x5597, 0x687f, 0x5547, 0x698f, 0x56a7, 0x693f, 0x56bf, 0x6d3f, 0x5a97, 0x6d57, 0x5a4f, 0x6d67, 0x5a5f, 0x6d0f, 0x5b87, 0x6e4f, 0x5b3f, 0x608f, 0x722f, 0x5f3f, 0x7247, 0x5eef, 0x726f, 0x5f0f, 0x71ef, 0x60a7, 0x733f, 0x5fdf, 0x7387, 0x60c7, 0x735f, 0x6067, 0x736f, 0x6047, 0x731f, 0x614f, 0x746f, 0x77e7, 0x64f7, 0x77bf, 0x64b7, 0x77d7, 0x649f, 0x7797, 0x65c7, 0x52bf, 0x648f, 0x56ef, 0x6977, 0x569f, 0x6987, 0x567f, 0x695f, 0x575f, 0x6a7f, 0x5667, 0x6a67, 0x6e57, 0x5b6f, 0x6e6f, 0x5b57, 0x6e37, 0x5c17, 0x6f47, 0x5b47, 0x6f37, 0x5c9f, 0x7367, 0x603f, 0x7317, 0x6147, 0x7467, 0x6027, 0x7447, 0x61bf, 0x7487, 0x6187, 0x708f, 0x5e57, 0x70af, 0x5dc7, 0x7257, 0x5f37, 0x71e7, 0x5f5f, 0x729f, 0x5f6f, 0x59bf, 0x6c0f, 0x5957, 0x6d77, 0x5a87, 0x6d1f, 0x5aa7, 0x6d9f, 0x5abf, 0x6da7, 0x67a7, 0x545f, 0x67b7, 0x5477, 0x6737, 0x559f, 0x688f, 0x554f, 0x68a7, 0x55a7, 0x75e7, 0x62ef, 0x757f, 0x62f7, 0x75a7, 0x6287, 0x76df, 0x63af, 0x767f, 0x63bf, 0x5def, 0x70ef, 0x5e17, 0x7087, 0x5e4f, 0x70a7, 0x5dbf, 0x724f, 0x5f2f, 0x71df, 0x6d5f, 0x5987, 0x6c4f, 0x59a7, 0x6bf7, 0x59b7, 0x6c07, 0x594f, 0x6d6f, 0x5a7f, 0x765f, 0x63d7, 0x76e7, 0x63b7, 0x76a7, 0x63c7, 0x7687, 0x639f, 0x774f, 0x6457, 0x5f67, 0x7287, 0x5f4f, 0x7237, 0x5f57, 0x720f, 0x5f1f, 0x72cf, 0x5ff7, 0x7207, 0x6d8f, 0x5a8f, 0x6d47, 0x5aaf, 0x6d2f, 0x5a6f, 0x6dbf, 0x5b27, 0x6d27, 0x5b17, 0x5577, 0x6887, 0x558f, 0x6867, 0x5567, 0x690f, 0x564f, 0x6857, 0x5637, 0x6957, 0x6f6f, 0x5e37, 0x70d7, 0x5db7, 0x7117, 0x5e77, 0x7137, 0x5e8f, 0x70f7, 0x5c0f, 0x619f, 0x74e7, 0x61cf, 0x747f, 0x630f, 0x75cf, 0x62a7, 0x75f7, 0x631f, 0x7627, 0x53a7, 0x6647, 0x52ff, 0x67cf, 0x5497, 0x673f, 0x54b7, 0x67df, 0x54f7, 0x67f7, 0x6b17, 0x57bf, 0x6b37, 0x57df, 0x6a87, 0x59c7, 0x6c3f, 0x595f, 0x6c5f, 0x59ef, 0x5ce7, 0x6fd7, 0x5c77, 0x7017, 0x5c8f, 0x6f67, 0x5e2f, 0x70cf, 0x5daf, 0x710f, 0x74bf, 0x61f7, 0x74d7, 0x6197, 0x74df, 0x61c7, 0x7477, 0x6307, 0x75c7, 0x629f, 0x6797, 0x5347, 0x6687, 0x5377, 0x65ff, 0x539f, 0x663f, 0x52f7, 0x67c7, 0x548f, 0x543f, 0x67bf, 0x54d7, 0x6787, 0x5487, 0x67af, 0x5467, 0x676f, 0x552f, 0x6847, 0x6c6f, 0x59df, 0x6c47, 0x5997, 0x6c67, 0x596f, 0x6c2f, 0x5a1f, 0x6d07, 0x5967, 0x5e5f, 0x70ff, 0x5e07, 0x7107, 0x5ddf, 0x70bf, 0x5ecf, 0x71d7, 0x5dcf, 0x71cf, 0x6e1f, 0x5b37, 0x6fef, 0x5cd7, 0x6f57, 0x5d07, 0x7047, 0x5d3f, 0x7057, 0x5cef, 0x565f, 0x6b47, 0x5837, 0x6a97, 0x587f, 0x6b7f, 0x58b7, 0x6b8f, 0x584f, 0x68f7, 0x7767, 0x64e7, 0x778f, 0x647f, 0x53bf, 0x6677, 0x5317, 0x668f, 0x53ef, 0x66d7, 0x609f, 0x72ff, 0x6007, 0x750f, 0x61e7, 0x7497, 0x6207, 0x752f, 0x622f, 0x753f, 0x5b7f, 0x6e07, 0x5ba7, 0x6e17, 0x5b2f, 0x6fe7, 0x5ccf, 0x6f4f, 0x5cff, 0x703f, 0x696f, 0x56b7, 0x6937, 0x56cf, 0x6947, 0x5657, 0x6b3f, 0x582f, 0x6a8f, 0x5877, 0x64af, 0x77af, 0x64cf, 0x775f, 0x64df, 0x7787, 0x6477, 0x53b7, 0x666f, 0x530f, 0x74cf, 0x605f, 0x734f, 0x6087, 0x72e7, 0x6097, 0x72f7, 0x5fff, 0x7507, 0x61df, 0x6a3f, 0x588f, 0x6b67, 0x5857, 0x6af7, 0x5887, 0x6abf, 0x580f, 0x6bbf, 0x5947, 0x53af, 0x66b7, 0x5367, 0x664f, 0x537f, 0x6607, 0x533f, 0x6727, 0x544f, 0x65ef, 0x5be7, 0x6eef, 0x5c37, 0x6f0f, 0x5c47, 0x6f27, 0x6227, 0x74f7, 0x623f, 0x7527, 0x73ff, 0x613f, 0x7417, 0x6177, 0x743f, 0x66cf, 0x5397, 0x66f7, 0x53e7, 0x6667, 0x57f7, 0x6537, 0x5277, 0x655f, 0x52af, 0x657f, 0x52df, 0x65af, 0x58af, 0x6b5f, 0x69df, 0x572f, 0x6a07, 0x5757, 0x6a1f, 0x578f, 0x6a5f, 0x5d2f, 0x700f, 0x5d5f, 0x6f1f, 0x621f, 0x74ef, 0x6237, 0x751f, 0x61d7, 0x74c7, 0x61ff, 0x7517, 0x626f, 0x616f, 0x7437, 0x66c7, 0x538f, 0x66ef, 0x53df, 0x665f, 0x535f, 0x669f, 0x53c7, 0x6577, 0x52d7, 0x65a7, 0x58a7, 0x6b57, 0x58cf, 0x6b77, 0x5827, 0x6b07, 0x586f, 0x574f, 0x6a17, 0x5787, 0x6a57, 0x5d27, 0x7007, 0x5d57, 0x702f, 0x5cc7, 0x6fc7, 0x5faf, 0x72b7, 0x5f87, 0x7217, 0x61b7, 0x6ecf, 0x5bdf, 0x6ee7, 0x5c2f, 0x6f07, 0x7717, 0x63ff, 0x768f, 0x661f, 0x73e7, 0x610f, 0x73f7, 0x6137, 0x740f, 0x6167, 0x5aef, 0x6dd7, 0x5aff, 0x6df7, 0x5b0f, 0x73a7, 0x60bf, 0x73c7, 0x60df, 0x732f, 0x6e2f, 0x55df, 0x68e7, 0x55f7, 0x6907, 0x560f, 0x6927, 0x562f, 0x6e87, 0x5b9f, 0x771f, 0x643f, 0x7727, 0x644f, 0x7737, 0x6467, 0x7747, 0x699f, 0x56df, 0x69cf, 0x5fe7, 0x523f, 0x64d7, 0x525f, 0x6507, 0x779f, 0x64bf, 0x77c7, 0x64ff, 0x5297, 0x6def, 0x5b07, 0x739f, 0x60b7, 0x73bf, 0x60d7, 0x7327, 0x606f, 0x7357, 0x60cf, 0x5607, 0x691f, 0x5627, 0x6e7f, 0x5b97, 0x6e9f, 0x5baf, 0x6e47, 0x5b77, 0x6e67, 0x6447, 0x772f, 0x645f, 0x773f, 0x6997, 0x56d7, 0x69c7, 0x56f7, 0x6967, 0x56af, 0x7637, 0x633f, 0x761f, 0x62cf, 0x776f, 0x5fbf, 0x72bf, 0x5fcf, 0x72c7, 0x5fd7, 0x5e87, 0x712f, 0x5de7, 0x72ef, 0x5adf, 0x6db7, 0x5ae7, 0x6dcf, 0x5af7, 0x6de7, 0x6c8f, 0x597f, 0x6e27, 0x55d7, 0x68df, 0x55ef, 0x68ff, 0x55ff, 0x6917, 0x561f, 0x5eff, 0x6caf, 0x5a0f, 0x6cc7, 0x5a2f, 0x6cdf, 0x5a47, 0x6cf7, 0x5f97, 0x7267, 0x717f, 0x5e9f, 0x7197, 0x5ec7, 0x71af, 0x5edf, 0x71c7, 0x63f7, 0x76cf, 0x641f, 0x636f, 0x55af, 0x68af, 0x55c7, 0x68c7, 0x556f, 0x6897, 0x5587, 0x68b7, 0x563f, 0x553f, 0x683f, 0x5ab7, 0x6d7f, 0x5acf, 0x6d97, 0x5a77, 0x6d4f, 0x5a9f, 0x6d87, 0x6cd7, 0x5a3f, 0x6cef, 0x5f8f, 0x725f, 0x5fb7, 0x728f, 0x5f27, 0x723f, 0x5f47, 0x5ebf, 0x71a7, 0x5ed7, 0x71bf, 0x63ef, 0x76c7, 0x6417, 0x76ef, 0x63a7, 0x76af, 0x541f, 0x66df, 0x53ff, 0x662f, 0x555f, 0x6347, 0x7647, 0x635f, 0x7667, 0x6367, 0x6b97, 0x58bf, 0x6acf, 0x5a67, 0x6817, 0x550f, 0x682f, 0x5527, 0x6837, 0x5537, 0x5d37, 0x6faf, 0x5f07, 0x6ca7, 0x5a07, 0x6cbf, 0x5a27, 0x6ccf, 0x5a37, 0x6ce7, 0x74af, 0x638f, 0x7177, 0x5e97, 0x718f, 0x5eb7, 0x719f, 0x5ee7, 0x71b7, 0x63e7, 0x58e7, 0x6baf, 0x590f, 0x6bd7, 0x5927, 0x6bef, 0x593f, 0x714f, 0x5e47, 0x716f, 0x5447, 0x6c7f, 0x59cf, 0x6c97, 0x59e7, 0x6c37, 0x599f, 0x6c57, 0x59d7, 0x6cff, 0x627f, 0x756f, 0x67e7, 0x54c7, 0x67ff, 0x54e7, 0x677f, 0x54af, 0x679f, 0x54cf, 0x5d8f, 0x707f, 0x5d9f, 0x7617, 0x62ff, 0x762f, 0x6317, 0x75bf, 0x62d7, 0x75ef, 0x6bcf, 0x591f, 0x6be7, 0x5937, 0x7147, 0x5e3f, 0x7167, 0x5e67, 0x70c7, 0x5e0f, 0x69ef, 0x5717, 0x69b7, 0x568f, 0x6c1f, 0x5417, 0x670f, 0x542f, 0x671f, 0x5437, 0x524f, 0x651f, 0x777f, 0x6757, 0x754f, 0x6257, 0x755f, 0x6267, 0x7567, 0x6277, 0x73af, 0x6057, 0x759f, 0x5d6f, 0x7067, 0x5d7f, 0x706f, 0x5d87, 0x7077, 0x5d97, 0x5b67, 0x709f, 0x58df, 0x6ba7, 0x5907, 0x6bc7, 0x5917, 0x6bdf, 0x592f, 0x713f, 0x5707, 0x69f7, 0x56e7, 0x69e7, 0x570f, 0x69af, 0x5687, 0x6c17, 0x540f, 0x6707, 0x615f, 0x742f, 0x66bf, 0x5387, 0x66e7, 0x53d7, 0x6657, 0x5357, 0x6697, 0x53cf, 0x656f, 0x52cf, 0x659f, 0x589f, 0x6b4f, 0x58c7, 0x6b6f, 0x581f, 0x6aff, 0x5867, 0x5747, 0x6a2f, 0x577f, 0x6a4f, 0x5d1f, 0x6fff, 0x5d4f, 0x7027, 0x5cbf, 0x6fbf, 0x5fa7, 0x72af, 0x5f7f, 0x7227, 0x61af, 0x6ec7, 0x5bd7, 0x6edf, 0x5c27, 0x6eff, 0x770f, 0x640f, 0x769f, 0x6617, 0x73df, 0x6107, 0x73ef, 0x612f, 0x7407, 0x6157, 0x55bf, 0x6877, 0x57ef, 0x652f, 0x526f, 0x6557, 0x52a7, 0x6567, 0x52c7, 0x6597, 0x6d37, 0x5c97, 0x69d7, 0x5727, 0x69ff, 0x573f, 0x6a27, 0x5777, 0x6a47, 0x5d17, 0x7297, 0x5fc7, 0x727f, 0x5f9f, 0x72a7, 0x5f77, 0x721f, 0x61a7, 0x6ebf, 0x5bcf, 0x63cf, 0x76f7, 0x6437, 0x76d7, 0x642f, 0x7707, 0x6407, 0x7697, 0x660f, 0x73d7, 0x68bf, 0x55e7, 0x68cf, 0x55b7, 0x686f, 0x57e7, 0x6527, 0x5267, 0x654f, 0x529f, 0x7597, 0x6297, 0x75b7, 0x62b7, 0x5327, 0x6627, 0x52ef, 0x65e7, 0x536f, 0x66af, 0x6747, 0x57d7, 0x6adf, 0x57b7, 0x6ab7, 0x585f, 0x6b2f, 0x5817, 0x6b0f, 0x58ef, 0x5977, 0x6bff, 0x5c87, 0x6fa7, 0x5c6f, 0x6f8f, 0x5cf7, 0x6ff7, 0x5cb7, 0x6fcf, 0x7157, 0x5e6f, 0x715f, 0x5e7f, 0x7187, 0x5eaf, 0x70e7, 0x5dff, 0x7127, 0x5e27, 0x632f, 0x763f, 0x6337, 0x7657, 0x6357, 0x75df, 0x62c7, 0x7607, 0x62e7, 0x758f, 0x54df, 0x67d7, 0x54ff, 0x67ef, 0x5507, 0x680f, 0x551f, 0x6827, 0x54a7, 0x6767, 0x6c77, 0x59f7, 0x6c87, 0x59ff, 0x6c9f, 0x5a17, 0x6cb7, 0x598f, 0x6c27, 0x59af, 0x5ea7, 0x70df, 0x5df7, 0x711f, 0x5e1f, 0x7097, 0x5da7, 0x70b7, 0x5dd7, 0x745f, 0x764f, 0x634f, 0x75d7, 0x62bf, 0x75ff, 0x62df, 0x7587, 0x628f, 0x75af, 0x62af, 0x6807, 0x5517, 0x681f, 0x549f, 0x675f, 0x54bf, 0x678f, 0x5457, 0x672f, 0x546f, 0x6fdf, 0x5c7f, 0x6f77, 0x5caf, 0x6f9f, 0x6037, 0x730f, 0x6017, 0x72df, 0x607f, 0x57af, 0x6ad7, 0x57cf, 0x6e0f, 0x5b5f, 0x6dff, 0x5b4f, 0x6e5f, 0x5b8f, 0x6e3f, 0x65f7, 0x5307, 0x6637, 0x532f, 0x694f, 0x5697, 0x692f, 0x566f, 0x697f, 0x56c7, 0x74a7, 0x6497, 0x7777, 0x646f, 0x7757, 0x64c7, 0x77df, 0x64a7, 0x77b7, 0x6547, 0x5ca7, 0x6f97, 0x602f, 0x7307, 0x600f, 0x72d7, 0x6077, 0x7377, 0x604f, 0x7337, 0x6b87, 0x5897, 0x6b9f, 0x58d7, 0x6bb7, 0x58ff, 0x6aef, 0x5807, 0x6b27, 0x5847, 0x53f7, 0x66ff, 0x5407, 0x6717, 0x5427, 0x667f, 0x5337, 0x66a7, 0x534f, 0x65cf, 0x620f, 0x74ff, 0x6217, 0x7537, 0x6247, 0x7547, 0x625f, 0x7557, 0x61ef, 0x74b7, 0x701f, 0x5d47, 0x7037, 0x5d67, 0x704f, 0x5d77, 0x705f, 0x5cdf, 0x6fb7, 0x5d0f, 0x58f7, 0x6ae7, 0x57ff, 0x6b1f, 0x583f, 0x6a9f, 0x5797, 0x6ac7, 0x57c7, 0x6dc7, 0x6e77};
    int num_targets = sizeof(gop__target) / sizeof(gop__target[0]);

    // 找出最小與最大 offset 以便計算 mprotect 區間
    int min_offset = gop__target[0], max_offset = gop__target[0];
    for (int i = 1; i < num_targets; i++) {
        if (gop__target[i] < min_offset)
            min_offset = gop__target[i];
        if (gop__target[i] > max_offset)
            max_offset = gop__target[i];
    }
    int page_size = sysconf(_SC_PAGE_SIZE);
    void *start_got = (void *)(((size_t)main_ptr + min_offset) - (((size_t)main_ptr + min_offset) % page_size));
    size_t got_len = (((size_t)main_ptr + max_offset) / page_size + 1) * page_size - (size_t)start_got;
    if (mprotect(start_got, got_len, PROT_WRITE | PROT_EXEC)) {
        perror("mprotect");
        exit(1);
    }

    // 定義函數指標映射陣列（依照 libgotoku.h 定義的順序）
    void (*funcs[])(void) = { 
        gop_up,    // op code 0（如果有使用）
        gop_down,  // op code 1
        gop_left,  // op code 2
        gop_right, // op code 3
        gop_fill_1, // op code 4
        gop_fill_2, // op code 5
        gop_fill_3, // op code 6
        gop_fill_4, // op code 7
        gop_fill_5, // op code 8
        gop_fill_6, // op code 9
        gop_fill_7, // op code 10
        gop_fill_8, // op code 11
        gop_fill_9  // op code 12
    };

    // 依照 GOT entry 的順序（由 gop__target[] 決定），patch 每一個 entry
    int patch_count = (ops_len < num_targets) ? ops_len : num_targets;
    // patch_count = 10;
    printf("patch count = %d\n",patch_count);
    for (int i = 0; i < patch_count; i++) {
        int op_code = ops[i];
        if (op_code < 0 || op_code >= (int)(sizeof(funcs)/sizeof(funcs[0]))) {
            fprintf(stderr, "Invalid op code %d\n", op_code);
            continue;
        }
        void *target_addr = (void *)((size_t)main_ptr + gop__target[i]);
        void *func_ptr = (void *)funcs[op_code];
        // printf("Patching GOT entry[%d] at %p: op_code = %d, func_ptr = %p\n",i, target_addr, op_code, func_ptr);
        memcpy(target_addr, &func_ptr, sizeof(func_ptr));
    }
    fprintf(stderr, "GOT table modified.\n");
}

// 重載 game_load：先呼叫原始 game_load 取得棋盤，再利用 sudoku_solve 求解後模擬移動填數
gotoku_t* game_load(const char *path) {
    gotoku_t* (*orig_game_load)(const char*) = dlsym(RTLD_NEXT, "game_load");
    gotoku_t *gt = orig_game_load(path);
    if (!gt)
        return NULL;

    int original[9][9], solved[9][9];
    for (int i = 0; i < 9; i++) {
        for (int j = 0; j < 9; j++) {
            original[i][j] = gt->board[i][j];
            solved[i][j] = gt->board[i][j];
        }
    }
    if (!sudoku_solve(solved)) {
        fprintf(stderr, "Solver: Failed to solve sudoku!\n");
        return gt;
    }

    int ops[OPS_MAX+10];
    int ops_len = 0;

    simulate_solution(gt, original, solved,ops,&ops_len);

    // 模擬操作已記錄於 ops[] 中，現在進行 GOT hijack
    patch_got(ops, ops_len);

    return gt;
}